name: Pull Request Workflow

on:
  pull_request:
    branches:
      - main

jobs:
  validate-template-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install AWS SAM CLI
        run: |
          pip install --user aws-sam-cli

      - name: Validate SAM Templates
        run: |
          find . -path "./.github" -prune -o \( -name "*.yaml" -o -name "*.yml" \) -print0 | while IFS= read -r -d '' template; do
           echo "Validating template: $template"
           sam validate --template-file "$template" --region us-east-2 --lint
          done        
        shell: bash

  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Ruby
        uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.7'  # Specify the Ruby version you need

      - name: Install cfn_nag locally
        run: gem install --user-install cfn-nag

      - name: Add gem binary to PATH
        run: echo "::add-path::$(ruby -r rubygems -e 'puts Gem.user_dir')/bin"

      - name: Run security scan on CloudFormation templates
        run: cfn_nag_scan --input-path .
      